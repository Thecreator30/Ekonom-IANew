datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. MERCHANTS (Tenants)
model Merchant {
  id              String   @id @default(uuid())
  email           String   @unique
  password_hash   String
  company_name    String
  subscription_plan String @default("FREE") // FREE, PRO, ENTERPRISE
  stripe_customer_id String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  promotions      Promotion[]
  welcome_offers  WelcomeOffer[]
  subscribers     Subscriber[]
  coupons         Coupon[]
  devices         Device[]
  audit_logs      AuditLog[]
  refresh_tokens  RefreshToken[]
  api_keys        ApiKey[]
  push_jobs       PushJob[]
  push_rate_limits PushRateLimit[]
  idempotency_keys IdempotencyKey[]
  
  @@index([email])
}

// 2. AUTH & SECURITY
model RefreshToken {
  id            String   @id @default(uuid())
  token_hash    String   @unique
  merchant_id   String
  merchant      Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  device_id     String?  // Linked to Device table or generic ID
  expires_at    DateTime
  revoked       Boolean  @default(false)
  created_at    DateTime @default(now())
  replaced_by   String?  // For rotation tracking

  @@index([merchant_id])
  @@index([token_hash])
}

model ApiKey {
  id          String   @id @default(uuid())
  merchant_id String
  merchant    Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  key_hash    String   @unique
  name        String?
  scopes      String[] // "read:promotions", "write:promotions"
  last_used   DateTime?
  created_at  DateTime @default(now())

  @@index([merchant_id])
}

model IdempotencyKey {
  id             String   @id @default(uuid())
  merchant_id    String
  merchant       Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  key            String
  endpoint       String
  response_body  String   // JSON stringified
  status_code    Int
  created_at     DateTime @default(now())
  expires_at     DateTime // e.g. 24h

  @@unique([merchant_id, key])
  @@index([created_at]) // for cleanup
}

// 3. CORE DOMAIN: PROMOTIONS
enum PromotionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Promotion {
  id              String          @id @default(uuid())
  merchant_id     String
  merchant        Merchant        @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  title           String
  description     String
  discount_value  String?         // "-20%", "10â‚¬ offert"
  discount_type   String?         // "PERCENTAGE" or "FIXED"
  status          PromotionStatus @default(DRAFT)
  target_segment  String?         // "all", "inactive_30d"
  scheduled_at    DateTime?
  published_at    DateTime?
  archived_at     DateTime?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt

  // Relations
  push_jobs       PushJob[]

  @@index([merchant_id, status])
}

// 4. WELCOME OFFERS (Anti-Fraud)
model WelcomeOffer {
  id              String   @id @default(uuid())
  merchant_id     String
  merchant        Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  offer_code      String   // Short code for QR
  discount_value  String   // "-10%"
  expiration_days Int      @default(30)
  active          Boolean  @default(true)
  created_at      DateTime @default(now())

  @@unique([merchant_id, offer_code])
}

model Device {
  id              String   @id @default(uuid())
  merchant_id     String
  merchant        Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  device_hash     String   // SHA256(ip + ua + lang + secret)
  first_seen      DateTime @default(now())
  last_seen       DateTime @updatedAt
  fraud_score     Int      @default(0)

  @@unique([merchant_id, device_hash])
}

// 5. SUBSCRIBERS & COUPONS
model Subscriber {
  id              String   @id @default(uuid())
  merchant_id     String
  merchant        Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  phone_number    String?  // Hashed or Encrypted
  push_token      String?
  push_enabled    Boolean  @default(true)
  join_date       DateTime @default(now())
  last_active_at  DateTime @default(now())

  coupons         Coupon[]

  @@index([merchant_id])
}

enum CouponStatus {
  ACTIVE
  USED
  EXPIRED
}

model Coupon {
  id              String       @id @default(uuid())
  merchant_id     String
  merchant        Merchant     @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  subscriber_id   String
  subscriber      Subscriber   @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  code            String       // Unique redemption code
  discount_value  String
  status          CouponStatus @default(ACTIVE)
  expires_at      DateTime
  redeemed_at     DateTime?
  created_at      DateTime     @default(now())

  @@index([merchant_id, status])
  @@index([subscriber_id])
}

// 6. PUSH SYSTEM
enum PushJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

model PushJob {
  id              String        @id @default(uuid())
  merchant_id     String
  merchant        Merchant      @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  promotion_id    String?
  promotion       Promotion?    @relation(fields: [promotion_id], references: [id])
  status          PushJobStatus @default(PENDING)
  payload         String        // JSON: { title, body, data }
  attempt_count   Int           @default(0)
  created_at      DateTime      @default(now())
  processed_at    DateTime?

  @@index([status, created_at]) // Worker queue index
}

model PushRateLimit {
  id              String   @id @default(uuid())
  merchant_id     String
  merchant        Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  date            String   // YYYY-MM-DD
  count           Int      @default(0)

  @@unique([merchant_id, date])
}

// 7. AUDIT LOGS
enum Severity {
  INFO
  WARNING
  HIGH
  CRITICAL
}

model AuditLog {
  id              String   @id @default(uuid())
  merchant_id     String
  merchant        Merchant @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  action          String   // "LOGIN", "PUBLISH_PROMO", "REDEEM_COUPON"
  severity        Severity @default(INFO)
  ip_address      String?
  user_agent      String?
  metadata        String?  // JSON
  created_at      DateTime @default(now())

  @@index([merchant_id, created_at])
}
